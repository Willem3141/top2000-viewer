<!doctype html>
<html>
  <head>
    <title>Top 2000-viewer</title>
    <link rel="stylesheet" type="text/css" href="layout.css">
  </head>
  <body>
    <div id="main-view">
      <div id="top2000-id-container">
        <div id="top2000-id-square-shadow-2"></div>
        <div id="top2000-id-square-shadow-1"></div>
        <div id="top2000-id-square"></div>
        <div id="top2000-id"></div>
      </div>
      <div id="current-song-container">
        <div>
          <span id="current-song-title">...</span><span id="current-song-votes"></span>
        </div>
        <div>
          <span id="current-song-artist">...</span>
        </div>
        <div id="progress-bar">
          <div id="progress-bar-fill">
          </div>
          <div id="progress-bar-knob">
          </div>
        </div>
        <div id="current-song-extra-info">
          <p><span id="current-song-year"></span><span id="current-song-difference"></span></p>
        </div>
      </div>
      <div id="previous-id">
      </div>
      <div id="previous-song-container">
        <div>
          <span id="previous-song-title"></span><span id="previous-song-votes"></span>
        </div>
        <div>
          <span id="previous-song-artist"></span>
        </div>
      </div>
      <div id="next-id">
      </div>
      <div id="next-song-container">
        <div>
          <span id="next-song-title"></span><span id="next-song-votes"></span>
        </div>
        <div>
          <span id="next-song-artist"></span>
        </div>
      </div>
      <div id="hour-overview">
        <div id="hour-overview-dialog">
          <div id="hour-overview-header">
            Uur ...
          </div>
          <div id="hour-overview-body">
            ...
          </div>
        </div>
      </div>
      <div id="clock">
        <img id="clock-image" src="timezones/0.png">
        </img>
        <div id="clock-timer">
          23:59:59
        </div>
      </div>
      <div id="huge-id-container">
        <div id="huge-id-square-container">
          <div id="huge-id-square-shadow-2"></div>
          <div id="huge-id-square-shadow-1"></div>
          <div id="huge-id-square"></div>
          <div id="huge-id"></div>
        </div>
      </div>
      <div id="notification">
      </div>
    </div>
    
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var startTime = 0;
      var stopTime = 0;
      
      var socket = io();
      
      var currentId = -1;
      
      socket.on('new song', function(msg) {
        if (msg.currentSong.id !== currentId) {
            $('#huge-id').html(msg.currentSong.id);
            
            $('#main-view').addClass("id-flash");
            
            setTimeout(function() {
            $('#main-view').removeClass("id-flash");
            }, 3000);
        }
        $('#main-view').removeClass('notification-shown');
        
        setTimeout(function() {
          $('#current-song-artist').html(msg.currentSong.artist);
          $('#current-song-title').html(msg.currentSong.title);
          $('#current-song-votes').html(createVotesText(msg.currentSong));
          $('#top2000-id').html(msg.currentSong.id);
          
          $('#current-song-year').html(msg.currentSong.year);

          var difference = msg.currentSong.previous - msg.currentSong.id;
          if (msg.currentSong.previous === 0) {
            $('#current-song-difference').html('&#9899;');

          } else if (difference > 0) {
            $('#current-song-difference').html("&#9652; " + difference);

          } else if (difference < 0) {
            $('#current-song-difference').html("&#9662; " + (-difference));

          } else {
            $('#current-song-difference').html("&#8226; 0");
          }

          startTime = msg.currentSong.startTime;
          stopTime = msg.currentSong.stopTime;
          
          if (msg.previousSong) {
            $('#previous-song-artist').html(msg.previousSong.artist);
            $('#previous-song-title').html(msg.previousSong.title);
            $('#previous-song-votes').html(createVotesText(msg.previousSong));
            $('#previous-id').html(msg.previousSong.id);
          } else {
            $('#previous-song-artist').html('');
            $('#previous-song-title').html('');
            $('#previous-id').html('');
          }
          
          if (msg.nextSong) {
            $('#next-song-artist').html(msg.nextSong.artist);
            $('#next-song-title').html(msg.nextSong.title);
            $('#next-song-votes').html(createVotesText(msg.nextSong));
            $('#next-id').html(msg.nextSong.id);
          } else {
            $('#next-song-artist').html('');
            $('#next-song-title').html('');
            $('#next-id').html('');
          }
          if (msg.currentSong.id !== currentId) {
            currentId = msg.currentSong.id;
            $('#main-view').addClass("song-detail");
          }
          if (msg.currentSong.startTime && msg.currentSong.stopTime) {
            updateProgressBar();
            $('#progress-bar').css('opacity', 1);
          } else {
            $('#progress-bar').css('opacity', 0);
          }
        }, 1000);
        
        if (msg.currentSong.id !== currentId) {
          setTimeout(function() {
            $('#main-view').removeClass("song-detail");
          }, 10000);
        }
      });
      setInterval(updateProgressBar, 0.5);
      
      socket.on('error', function(message) {
        $('#main-view').addClass('notification-shown');
        $('#notification').html("De verbinding is verbroken ...<br><span class='notification-message'>" + message + "</span>");
      });

      function createVotesText(song) {
        if (!song.voters) {
          return '';
        }
        var votesHtml = '';
        for (var i = 0; i < song.voters.length; i++) {
          votesHtml += '<div class="vote-badge">' + song.voters[i] + '</div>';
        }
        return votesHtml;
      }
      
      function updateProgressBar() {
        var fraction = 100 * (new Date().getTime() - startTime) / (stopTime - startTime);
        if (fraction > 100) {
          fraction = 100;
          $('#progress-bar').css('opacity', 0);
        }
        $('#progress-bar-fill').css('width', fraction + '%');
        $('#progress-bar-knob').css('left', fraction + '%');
      }
      
      socket.on('hour overview', function(msg) {
        $('#hour-overview').addClass('visible');
        $('#hour-overview-header').html('Uur ' + (msg.hourCount + 1));
        $('#hour-overview-body').html('');
        for (var i = 0; i < msg.songs.length; i++) {
          var s = msg.songs[i];
          var difference = msg.songs[i].previous - msg.songs[i].id;
          if (msg.songs[i].previous === 0) {
            var diffString = '<div class="hour-overview-diff new">&#9899;</div>';
          } else if (difference > 0) {
            var diffString = '<div class="hour-overview-diff climbs">' + difference + '</div>';
          } else if (difference < 0) {
            var diffString = '<div class="hour-overview-diff descends">' + -difference + '</div>';
          } else {
            var diffString = '<div class="hour-overview-diff equal">=</div>';
          }
          $('#hour-overview-body').append('<div class="hour-overview-song"><div class="hour-overview-id">' + s.id + '</div>'+ diffString + '<div class="hour-overview-title"><b>' + s.title + '</b><br>' + s.artist + '</div></div>');
        }
        setTimeout(function() {
          $('#hour-overview').removeClass('visible');
        }, 120000);
      });

      setInterval(updateClock, 1000);

      function updateClock() {
        let date = new Date();
        // show clock only on 31 December or 1 Jan
        if (!((date.getMonth() === 11 && date.getDate() === 31 && date.getHours() >= 12) ||
              (date.getMonth() === 0 && date.getDate() === 1 && date.getHours() === 0 && date.getMinutes() < 15))) {
          $('#clock').toggleClass('visible', false);
          return;
        }
        $('#clock-timer').html(date.getHours() + ":" +
            (date.getMinutes() < 10 ? "0" : "") +
            date.getMinutes() + ":" +
            (date.getSeconds() < 10 ? "0" : "") +
            date.getSeconds());
        $('#clock-image').attr('src', 'timezones/' + date.getHours() + '.png');
        
        let showClock = false;
        // show clock around each hour
        if (date.getMinutes() === 59 && date.getSeconds() > 50) {
          showClock = true;
        }
        if (date.getMinutes() === 0 && date.getSeconds() < 20) {
          showClock = true;
        }
        // also show it after New Year
        if (date.getHours() === 23 &&
            date.getMinutes() === 56 && date.getSeconds() > 0) {
          showClock = true;
        }
        if (date.getMonth() === 0) {
          showClock = true;
        }
        $('#clock').toggleClass('visible', showClock);
      }
    </script>
  </body>
</html>
